I"˜<p>Flask æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘æƒ³æ‰“å¼€è¿™ç¯‡æ–‡ç« çš„ä½ åº”è¯¥ä¸é™Œç”Ÿï¼Œä½†æ˜¯æˆ‘è¿˜å¼•ç”¨ç»´åŸºç™¾ç§‘ä¸Šçš„å†…å®¹åšä¸ªç®€çŸ­çš„ä»‹ç»ã€‚</p>

<blockquote>
  <p>Flask æ˜¯ä¸€ä¸ªä½¿ç”¨ Python ç¼–å†™çš„è½»é‡çº§ Web åº”ç”¨æ¡†æ¶ã€‚åŸºäº Werkzeug WSGI å·¥å…·ç®±å’Œ Jinja2 æ¨¡æ¿å¼•æ“ã€‚Flask ä½¿ç”¨ BSD æˆæƒã€‚<br />
Flask è¢«ç§°ä¸º â€œmicroframeworkâ€ï¼Œå› ä¸ºå®ƒä½¿ç”¨ç®€å•çš„æ ¸å¿ƒï¼Œç”¨ extension å¢åŠ å…¶ä»–åŠŸèƒ½ã€‚Flask æ²¡æœ‰é»˜è®¤ä½¿ç”¨çš„æ•°æ®åº“ã€çª—ä½“éªŒè¯å·¥å…·ã€‚ç„¶è€Œï¼ŒFlask ä¿ç•™äº†æ‰©å¢çš„å¼¹æ€§ï¼Œå¯ä»¥ç”¨ Flask-extension åŠ å…¥è¿™äº›åŠŸèƒ½ï¼šORMã€çª—ä½“éªŒè¯å·¥å…·ã€æ–‡ä»¶ä¸Šä¼ ã€å„ç§å¼€æ”¾å¼èº«ä»½éªŒè¯æŠ€æœ¯ã€‚</p>
</blockquote>

<p>ç®€å•æ¥è¯´ Flask æ˜¯ä¸€ä¸ªä½¿ç”¨ Python è¯­è¨€çš„ Web æœåŠ¡æ¡†æ¶ï¼Œä½†æ˜¯ Flask ä»…å®ç°äº†éƒ¨åˆ†åŠŸèƒ½ï¼Œå¤§å¤šæ•°åŠŸèƒ½é€šè¿‡æ‰©å±•æ¥å®ç°ï¼Œä½¿ç”¨è€…å¯ä»¥ç”¨è‡ªå·±æœ€ç†Ÿæ‚‰çš„æ¨¡å—æ¥å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚</p>

<p>å½“ç„¶ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸æ˜¯æ¥ä»‹ç» Flask çš„ï¼Œè€Œæ˜¯å¦‚ä½•åœ¨ Flask ä¸­å¢åŠ ç”¨æˆ·ç®¡ç†ã€Œç”¨æˆ·ç™»å½•ã€çš„åŠŸèƒ½ã€‚Flask æ˜¯ä¸€ä¸ª Web æ¡†æ¶ï¼Œåœ¨æœåŠ¡ç«¯éœ€è¦å®ç°çš„ç”¨æˆ·ç™»å½•ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡ç½‘é¡µç™»å½•ï¼Œå¦ä¸€ä¸ªæ˜¯é€šè¿‡ API ç™»å½•ã€‚è¿™é‡Œå°†å¸¦ä½ å®ç°è¿™ä¸¤ç§æ–¹å¼çš„ç”¨æˆ·ç™»å½•ã€‚</p>

<h2 id="ç½‘é¡µä¸­çš„ç”¨æˆ·ç™»å½•å®ç°">ç½‘é¡µä¸­çš„ç”¨æˆ·ç™»å½•å®ç°</h2>
<p>åœ¨ Flask ä¸­ç½‘é¡µçš„ç”¨æˆ·ç™»å½•ï¼Œä¸»è¦é€šè¿‡ Flask-Login æ‰©å±•æ¥å®Œæˆï¼Œ
é€šè¿‡ Flask-Login å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
  <li>å­˜å‚¨ä¼šè¯ä¸­æ´»åŠ¨ç”¨æˆ·çš„ IDï¼Œå¹¶å…è®¸ä½ éšæ„ç™»å…¥ç™»å‡ºã€‚</li>
  <li>è®©ä½ é™åˆ¶å·²ç™»å…¥ï¼ˆæˆ–å·²ç™»å‡ºï¼‰ç”¨æˆ·è®¿é—®è§†å›¾ã€‚</li>
  <li>å®ç°æ£˜æ‰‹çš„â€œè®°ä½æˆ‘â€åŠŸèƒ½ã€‚</li>
  <li>ä¿æŠ¤ç”¨æˆ·ä¼šè¯å…é­ Cookie ç›—ç”¨ã€‚</li>
  <li>éšåå¯èƒ½ä¼šä¸ Flask-Principal æˆ–å…¶å®ƒè®¤è¯æ‰©å±•é›†æˆã€‚</li>
</ul>

<p>åœ¨ä½¿ç”¨ Flask-Login ä¹‹å‰éœ€è¦ç”¨ pip æ¥å®‰è£…å®ƒï¼Œå¯¹ Flask-Login çš„ä½¿ç”¨ä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚</p>

<p>ä¸€ã€å»ºç«‹ LoginManager çš„å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ Flask åˆå§‹åŒ– Flask-Loginã€‚</p>
<pre><code class="language-python">loginmanager = LoginManager()
loginmanager.init_app(app)
</code></pre>
<p>äºŒã€å»ºç«‹ user_loader çš„å›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°é€šè¿‡ user_id æ¥è·å– user å¯¹è±¡ã€‚</p>
<pre><code class="language-python">    @login_manager.user_loader
    def load_user(user_id):
        """Loads the user. Required by the `login` extension."""
        user_instance = User.query.filter_by(id=user_id).first()
        if user_instance:
            return user_instance
        else:
            return None
</code></pre>
<p>ä¸‰ã€å»ºç«‹ç”¨æˆ·ç±»ã€‚ç”¨æˆ·ç±»ç»§æ‰¿è‡ª UserMixinï¼Œå®ƒæä¾›äº† is_authenticatedã€is_activeã€is_anonymousã€get_id ç­‰æ–¹æ³•çš„é»˜è®¤å®ç°ã€‚</p>

<p>å››ã€å»ºç«‹ç”¨æˆ·ç™»å½•é¡µé¢ï¼Œéœ€è¦åŒ…å«è¾“å…¥æ¡†åŠæäº¤æŒ‰é’®ã€‚</p>

<p>äº”ã€å»ºç«‹ç™»å½•è§†å›¾ï¼Œå¹¶åœ¨ç™»å½•éªŒè¯å®Œæˆæ˜¯è°ƒç”¨ login_user å‡½æ•°ã€‚</p>
<pre><code class="language-python">class Login(MethodView):
    def get(self):
        return render_template('user/login.html')

    def post(self):
        username = request.form['username']
        password = request.form['password']
        remember = True if request.form.get('remember') else False
        logger.info(remember)
        user = User.query.filter_by(name=username).first()
        if user and user.check_password(password):
            login_user(user, remember=remember)
            next = request.args.get('next')
            return redirect(next or url_for('brand.bar'))
        return render_template('user/login.html')
</code></pre>

<p>ç¨‹åºå®ç°åˆ°ç°åœ¨ï¼Œç”¨æˆ·ç™»å½•çš„æ•´ä¸ªè¿‡ç¨‹å·²ç»å®Œæˆï¼Œå¯ä»¥é€šè¿‡ç”¨æˆ·åå’Œå¯†ç æ¥å®ç°ç”¨æˆ·çš„éªŒè¯ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°æ‰€æœ‰çš„ url ä½ è¿˜æ˜¯å¯ä»¥åœ¨æ²¡æœ‰ç™»å½•çš„çŠ¶æ€ä¸‹è®¿é—®ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿éœ€è¦ç™»å½•çš„ url å¤„äºä¿æŠ¤çŠ¶æ€å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨ login_required æ ‡ç­¾ã€‚</p>
<pre><code class="language-python">class BrandBar(MethodView):
    decorators = [login_required]

    def get(self):
        brands = [name[0] for name in db.session.query(Brands.name).all()]
        # brands = db.session.query(Brands).all()
        return render_template('brand_bar.html', brands=brands)
</code></pre>

<p>å½“ä½ è®¿é—®ä¸€ä¸ªéœ€è¦ç™»å½•æ‰èƒ½è®¿é—®çš„è§†å›¾æ—¶ï¼Œå¸Œæœ›èƒ½å¤Ÿè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œæ­¤æ—¶è¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„ç™»å½•è§†å›¾ï¼Œè®¾ç½®æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-python">login_manager.login_view = 'user.login'
</code></pre>

<p>ç°åœ¨æ•´ä¸ªç™»å½•è¿‡ç¨‹æ‰ç®—å®Œæ•´ï¼Œå½“ä½ è®¿é—® BrandBar è§†å›¾æ—¶ï¼Œæœªç™»å½•æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæ•´ç™»å½•åä¼šè‡ªåŠ¨è·³è½¬åˆ° BrandBar è§†å›¾ã€‚</p>

<h2 id="api-ä¸­çš„ç”¨æˆ·ç™»å½•å®ç°">API ä¸­çš„ç”¨æˆ·ç™»å½•å®ç°</h2>
<p>REST API æ˜¯é€šè¿‡ API æ¥è®¿é—®æœåŠ¡ç«¯æ•°æ®ï¼ŒæœåŠ¡ç«¯è¿”å›çš„æ•°æ®é€šå¸¸æ˜¯ JSON æ ¼å¼ï¼ŒAPI çš„ç”¨æˆ·ç™»å½•å®ç°æˆ‘ä»¬é€šè¿‡ flask_httpauth æ¥å®Œæˆã€‚é€šè¿‡ flask_httpauth å¯ä»¥é€šè¿‡ token æ¥ç™»å½•ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½åœ¨ http è¯·æ±‚ä¸­æºå¸¦ç”¨æˆ·åå’Œå¯†ç ã€‚</p>

<p>åœ¨ä½¿ç”¨ flask_httpauth å‰éœ€è¦å…ˆå®‰è£…ã€Œé‡‡ç”¨ç»Ÿä¸€çš„ pip æ¥å®‰è£… python æ¨¡å—ã€å’Œåˆå§‹åŒ– flask_httpauthã€‚</p>
<pre><code class="language-python">from flask_httpauth import HTTPBasicAuth

auth = HTTPBasicAuth()
</code></pre>

<p>è®¾ç½® verify_password å›è°ƒå‡½æ•°ã€‚</p>
<pre><code class="language-python">@auth.verify_password
def verify_password(username_or_token, password):
    # first try to authenticate by token
    user = User.verify_auth_token(username_or_token, current_app)
    logger.info('username:{} password:{}'.format(username_or_token, password))
    if not user:
        # try to authenticate with username/password
        user = User.query.filter_by(name = username_or_token).first()
        if not user or not user.check_password(password):
            return False
    g.current_user = user
    return True
</code></pre>
<blockquote>
  <p>verify_password å›è°ƒå‡½æ•°åŒæ—¶æ¥æ”¶ç”¨æˆ·å/å¯†ç ã€token ä¸¤ç§æ–¹å¼æ¥å®Œæˆç™»å½•ã€‚åœ¨ç”¨æˆ·ç±»ä¸­éœ€è¦å®ç°é€šè¿‡å¯†ç å’Œ token è¿›è¡ŒéªŒè¯çš„æ–¹æ³•ã€‚</p>
</blockquote>

<pre><code class="language-python">class User(db.Model, UserMixin, CRUDMixin):

    ....

    def check_password(self, password):
        """Check passwords. If passwords match it returns true, else false."""

        if self.password is None:
            return False
        return check_password_hash(self.password, password)

    def generate_auth_token(self, app, expiration = 600):
        s = Serializer(app.config['SECRET_KEY'], expires_in = expiration)
        return s.dumps({ 'id': self.id })

    @staticmethod
    def verify_auth_token(token, app):
        s = Serializer(app.config['SECRET_KEY'])
        try:
            data = s.loads(token)
        # except SignatureExpired:
        #     return None # valid token, but expired
        except BadSignature:
            return None # invalid token
        user = User.query.get(data['id'])
        return user
</code></pre>
<p>æ˜¯åœ¨ç™»å½•å®Œæˆåé€šè¿‡ API æ¥è·å– token ï¼Œä»¥åè®¿é—® API å¯ä»¥ç›´æ¥æºå¸¦ token æ— éœ€ä½¿ç”¨ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œç™»å½•ã€‚</p>

<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®ç°é€šè¿‡ç”¨æˆ·åå’Œå¯†ç æ¥è·å–è®¤è¯ token</p>
<pre><code>curl -u test:test -i -X GET http://127.0.0.1:5000/api/v0.1/user/token
</code></pre>
<p>è·å– token åï¼Œå³å¯é€šè¿‡ token æ¥è®¿é—®</p>
<pre><code>curl -X GET -H "Authorization: Bearer secret-token-1" http://127.0.0.1:5000/api/v0.1/user/token
</code></pre>
<blockquote>
  <p>éœ€è¦ç»è¿‡è®¤è¯æ‰èƒ½è®¿é—®çš„ API è¯·è‡³äº auth.login_required çš„ä¿æŠ¤ä¹‹ä¸­ã€‚</p>
  <h2 id="åè®°">åè®°</h2>
  <p>æœ¬æ¬¡å®ç°ç½‘é¡µç«¯å’Œ API ç«¯ç®€å•çš„ç”¨æˆ·è®¤è¯åŠŸèƒ½ï¼Œè¿˜éœ€è®¸å¤šåŠŸèƒ½éœ€è¦è¿›ä¸€æ­¥å‘ç°ï¼Œæ¯”å¦‚ flask_httpauth çš„å…¶ä»–è®¤è¯æ–¹å¼ï¼Œç½‘é¡µç«¯å’Œ API ä¹‹é—´çš„è®¤è¯æ‰“é€šï¼Œè¿™äº›åŠŸèƒ½ç•™å¾…ä»¥åè¿›ä¸€æ­¥å­¦ä¹ å§ï¼</p>
</blockquote>
:ET